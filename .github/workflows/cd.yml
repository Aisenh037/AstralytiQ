name: üöÄ Continuous Deployment

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  PYTHON_VERSION: '3.9'

jobs:
  # Build and Push Docker Images
  build-and-push:
    name: üê≥ Build & Push Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-tag: ${{ steps.meta.outputs.tags }}
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
      
    - name: üê≥ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: üîê Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: üè∑Ô∏è Extract Metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=sha,prefix={{branch}}-
          
    - name: üî® Build and Push Docker Image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.streamlit
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64
        
    - name: üîç Generate SBOM
      uses: anchore/sbom-action@v0
      with:
        image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        format: spdx-json
        output-file: sbom.spdx.json
        
    - name: üì§ Upload SBOM
      uses: actions/upload-artifact@v3
      with:
        name: sbom
        path: sbom.spdx.json

  # Security Scanning
  security-scan:
    name: üõ°Ô∏è Security Scan
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      security-events: write
    
    steps:
    - name: üîç Run Trivy Vulnerability Scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ needs.build-and-push.outputs.image-tag }}
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: üì§ Upload Trivy Scan Results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'

  # Deploy to Staging
  deploy-staging:
    name: üé≠ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-and-push, security-scan]
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: https://astralytiq-staging.streamlit.app
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
      
    - name: üöÄ Deploy to Streamlit Cloud (Staging)
      run: |
        echo "üé≠ Deploying to Staging Environment"
        echo "Image: ${{ needs.build-and-push.outputs.image-tag }}"
        echo "Commit: ${{ github.sha }}"
        
        # In a real scenario, this would trigger Streamlit Cloud deployment
        # or deploy to your staging Kubernetes cluster
        
        # Example: Update Kubernetes deployment
        # kubectl set image deployment/astralytiq-staging astralytiq=${{ needs.build-and-push.outputs.image-tag }}
        
        # Example: Trigger Streamlit Cloud deployment via API
        # curl -X POST "https://share.streamlit.io/api/v1/deploy" \
        #      -H "Authorization: Bearer ${{ secrets.STREAMLIT_TOKEN }}" \
        #      -d '{"repo": "${{ github.repository }}", "branch": "main"}'
        
    - name: üß™ Run Smoke Tests
      run: |
        echo "üß™ Running smoke tests against staging"
        # Add actual smoke tests here
        sleep 5
        echo "‚úÖ Smoke tests passed"
        
    - name: üìä Update Deployment Status
      run: |
        echo "## üé≠ Staging Deployment" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: Staging" >> $GITHUB_STEP_SUMMARY
        echo "- **Image**: \`${{ needs.build-and-push.outputs.image-tag }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ‚úÖ Deployed Successfully" >> $GITHUB_STEP_SUMMARY
        echo "- **URL**: https://astralytiq-staging.streamlit.app" >> $GITHUB_STEP_SUMMARY

  # Integration Tests on Staging
  integration-tests:
    name: üîó Integration Tests
    runs-on: ubuntu-latest
    needs: deploy-staging
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
      
    - name: üêç Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: üîß Install Test Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest requests selenium
        
    - name: üß™ Run Integration Tests
      run: |
        pytest tests/integration/ -v --staging-url=https://astralytiq-staging.streamlit.app
        
    - name: üì§ Upload Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: integration-test-results
        path: pytest-report.xml

  # Performance Tests on Staging
  performance-tests:
    name: ‚ö° Performance Tests
    runs-on: ubuntu-latest
    needs: deploy-staging
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
      
    - name: üêç Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: üîß Install Performance Test Tools
      run: |
        python -m pip install --upgrade pip
        pip install locust
        
    - name: ‚ö° Run Performance Tests
      run: |
        locust -f tests/performance/locustfile.py \
               --host=https://astralytiq-staging.streamlit.app \
               --users 50 --spawn-rate 5 --run-time 300s --headless \
               --html performance-report.html --csv performance-results
               
    - name: üìä Analyze Performance Results
      run: |
        python scripts/analyze_performance.py performance-results_stats.csv
        
    - name: üì§ Upload Performance Report
      uses: actions/upload-artifact@v3
      with:
        name: performance-report
        path: |
          performance-report.html
          performance-results*.csv

  # Deploy to Production
  deploy-production:
    name: üåü Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-and-push, security-scan, integration-tests, performance-tests]
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment:
      name: production
      url: https://astralytiq.streamlit.app
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
      
    - name: üåü Deploy to Production
      run: |
        echo "üåü Deploying to Production Environment"
        echo "Image: ${{ needs.build-and-push.outputs.image-tag }}"
        echo "Commit: ${{ github.sha }}"
        
        # Production deployment logic
        # This would typically involve:
        # 1. Blue-green deployment
        # 2. Database migrations
        # 3. Feature flag updates
        # 4. CDN cache invalidation
        
        # Example: Deploy to Streamlit Cloud
        # curl -X POST "https://share.streamlit.io/api/v1/deploy" \
        #      -H "Authorization: Bearer ${{ secrets.STREAMLIT_PROD_TOKEN }}" \
        #      -d '{"repo": "${{ github.repository }}", "branch": "main"}'
        
    - name: üß™ Run Production Smoke Tests
      run: |
        echo "üß™ Running production smoke tests"
        # Add production smoke tests
        sleep 10
        echo "‚úÖ Production smoke tests passed"
        
    - name: üìä Update Production Status
      run: |
        echo "## üåü Production Deployment" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
        echo "- **Image**: \`${{ needs.build-and-push.outputs.image-tag }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ‚úÖ Deployed Successfully" >> $GITHUB_STEP_SUMMARY
        echo "- **URL**: https://astralytiq.streamlit.app" >> $GITHUB_STEP_SUMMARY

  # Create GitHub Release
  create-release:
    name: üì¶ Create Release
    runs-on: ubuntu-latest
    needs: deploy-production
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: üìù Generate Release Notes
      id: release-notes
      run: |
        # Generate release notes from commits
        echo "## üöÄ What's New" > release-notes.md
        echo "" >> release-notes.md
        git log --pretty=format:"- %s (%h)" $(git describe --tags --abbrev=0 HEAD^)..HEAD >> release-notes.md
        echo "" >> release-notes.md
        echo "## üê≥ Docker Images" >> release-notes.md
        echo "- \`${{ needs.build-and-push.outputs.image-tag }}\`" >> release-notes.md
        echo "" >> release-notes.md
        echo "## üîó Links" >> release-notes.md
        echo "- [Live Application](https://astralytiq.streamlit.app)" >> release-notes.md
        echo "- [Documentation](https://docs.astralytiq.com)" >> release-notes.md
        echo "- [API Reference](https://api.astralytiq.com)" >> release-notes.md
        
    - name: üì¶ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        body_path: release-notes.md
        files: |
          sbom.spdx.json
        generate_release_notes: true
        make_latest: true

  # Notify Teams
  notify:
    name: üì¢ Notify Teams
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()
    
    steps:
    - name: üì¢ Slack Notification
      uses: 8398a7/action-slack@v3
      if: always()
      with:
        status: ${{ job.status }}
        channel: '#deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        fields: repo,message,commit,author,action,eventName,ref,workflow
        custom_payload: |
          {
            "text": "üöÄ AstralytiQ Deployment",
            "attachments": [{
              "color": "${{ job.status == 'success' && 'good' || 'danger' }}",
              "fields": [{
                "title": "Environment",
                "value": "${{ needs.deploy-production.result == 'success' && 'Production' || 'Staging' }}",
                "short": true
              }, {
                "title": "Status",
                "value": "${{ job.status == 'success' && '‚úÖ Success' || '‚ùå Failed' }}",
                "short": true
              }, {
                "title": "Commit",
                "value": "${{ github.sha }}",
                "short": true
              }, {
                "title": "Author",
                "value": "${{ github.actor }}",
                "short": true
              }]
            }]
          }
          
    - name: üìß Email Notification
      uses: dawidd6/action-send-mail@v3
      if: failure()
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "üö® AstralytiQ Deployment Failed"
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: "AstralytiQ CI/CD <noreply@astralytiq.com>"
        body: |
          Deployment failed for AstralytiQ.
          
          Repository: ${{ github.repository }}
          Commit: ${{ github.sha }}
          Author: ${{ github.actor }}
          Workflow: ${{ github.workflow }}
          
          Please check the GitHub Actions logs for more details.

  # Update Documentation
  update-docs:
    name: üìö Update Documentation
    runs-on: ubuntu-latest
    needs: deploy-production
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
      
    - name: üêç Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: üîß Install Documentation Tools
      run: |
        python -m pip install --upgrade pip
        pip install mkdocs mkdocs-material mkdocs-mermaid2-plugin
        
    - name: üî® Build Documentation
      run: |
        mkdocs build
        
    - name: üöÄ Deploy Documentation
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./site
        cname: docs.astralytiq.com

  # Cleanup
  cleanup:
    name: üßπ Cleanup
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production, create-release]
    if: always()
    
    steps:
    - name: üßπ Clean up old images
      run: |
        echo "üßπ Cleaning up old container images"
        # This would typically clean up old images from the registry
        # to save storage space
        
    - name: üìä Deployment Summary
      run: |
        echo "## üéâ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üìä Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Staging**: ${{ needs.deploy-staging.result == 'success' && '‚úÖ Success' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Production**: ${{ needs.deploy-production.result == 'success' && '‚úÖ Success' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Release**: ${{ needs.create-release.result == 'success' && '‚úÖ Created' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üîó Links" >> $GITHUB_STEP_SUMMARY
        echo "- [üåü Production App](https://astralytiq.streamlit.app)" >> $GITHUB_STEP_SUMMARY
        echo "- [üé≠ Staging App](https://astralytiq-staging.streamlit.app)" >> $GITHUB_STEP_SUMMARY
        echo "- [üìö Documentation](https://docs.astralytiq.com)" >> $GITHUB_STEP_SUMMARY